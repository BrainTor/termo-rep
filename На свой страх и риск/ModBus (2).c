#include "t5los8051.h"
#include "SysTime.h"
#include "ModBus.h"
#include "sys.h"

#define BaudH_9600 0x0A // 0x0A - 9600
#define BaudL_9600 0x80 // 0x80 - 9600
#define BaudH_115200 0x00 // 0x00 - 115200
#define BaudL_115200 0xE0 // 0xE0 - 115200

u8	code MB_speed=Modbus_Speed;

sbit TX2 = P0^4;
sbit TR4 = P0^0;
sbit TR5 = P0^1;

sbit RTC_SDA = P3^3; 
sbit RTC_SCL = P3^2;

u8 xdata BT[]= {
//0   1     2     3     4     5     6     7     8     9     10    11                         
0x5A, 0x01, 0x05, 0x01, 0x30, 0x04, 0x00, 0x00, 0x10, 0x00, 0x00, 0x10,	//001 
0x5A, 0x01, 0x06, 0x01, 0x30, 0x04, 0x00, 0x00, 0x20, 0x00, 0x20, 0x00,	//002
0x5A, 0x01, 0x06, 0x01, 0x30, 0x03, 0x00, 0x00, 0x30, 0x00, 0x30, 0x00,	//003 
0x5A, 0x01, 0x01, 0x11, 0x30, 0x01, 0x00, 0x00, 0x11, 0x00, 0x00, 0x00,	//004
0x0A, 0x01, 0x05, 0x01, 0x30, 0x04, 0x00, 0x00, 0x10, 0x00, 0x00, 0x10,	//005   //M16

0x0A, 0x01, 0x05, 0x01, 0x30, 0x04, 0x00, 0x00, 0x10, 0x01, 0x00, 0x50,	//006   //M80
0x0A, 0x01, 0x05, 0x01, 0x30, 0x04, 0x00, 0x00, 0x10, 0x02, 0x00, 0x51,	//007 	//M81
0x0A, 0x01, 0x05, 0x01, 0x30, 0x04, 0x00, 0x00, 0x10, 0x03, 0x00, 0x52,	//008	  //M82
0x0A, 0x01, 0x05, 0x01, 0x30, 0x04, 0x00, 0x00, 0x10, 0x04, 0x00, 0x53,	//009 	//M83
0x0A, 0x01, 0x05, 0x01, 0x30, 0x04, 0x00, 0x00, 0x10, 0x05, 0x00, 0x54,	//010	  //M84
  
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//011 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//012
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//013 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//014
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//015
 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//016
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//017 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//018
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//019 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//020 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//021 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//022
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//023 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//024
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//025 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//026
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//027 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//028
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//029 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//030 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//031 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//032
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//033 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//034
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//035 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//036
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//037 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//038
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//039 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//040 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//041 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//042
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//043 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//044
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//045 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//046
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//047 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//048
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//049 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//050 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//051 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//052
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//053 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//054
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//055 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//056
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//057 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//058
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//059 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//060 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//061 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//062
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//063 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//064
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//065 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//066
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//067 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//068
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//069 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//070 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//071 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//072
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//073 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//074
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//075 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//076
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//077 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//078
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//079 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//080 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//081 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//082
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//083 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//084
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//085 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//086
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//087 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//088
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//089 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//090 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//091 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//092
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//093 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//094
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//095 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//096
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//097 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//098
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//099 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//100 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//101 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//102
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//103 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//104
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//105 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//106
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//107 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//108
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//109 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//110  

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//111 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//112
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//113 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//114
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//115 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//116
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//117 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//118
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//119 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//120 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//121 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//122
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//123 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//124
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//125 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//126
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//127 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//128
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//129 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//130 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//131 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//132
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//133 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//134
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//135 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//136
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//137 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//138
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//139 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//140 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//141 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//142
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//143 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//144
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//145 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//146
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//147 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//148
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//149 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//150 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//151 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//152
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//153 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//154
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//155 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//156
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//157 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//158
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//159 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//160 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//161 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//162
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//163 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//164
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//165 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//166
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//167 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//168
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//169 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//170 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//171 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//172
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//173 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//174
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//175 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//176
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//177 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//178
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//179 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//180 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//181 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//182
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//183 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//184
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//185 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//186
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//187 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//188
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//189 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//190 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//191 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//192
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//193 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//194
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//195 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//196
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//197 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//198
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//199 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//200 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//201 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//202
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//203 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//204
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//205 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//206
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//207 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//208
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//209 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//210  

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//211 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//212
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//213 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//214
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//215 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//216
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//217 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//218
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//219 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//220 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//221 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//222
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//223 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//224
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//225 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//226
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//227 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//228
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//229 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//230 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//231 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//232
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//233 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//234
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//235 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//236
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//237 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//238
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//239 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//240 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//241 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//242
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//243 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//244
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//245 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//246
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//247 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//248
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//249 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//250 

0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//251 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//252
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//253 
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,	//254
0x0A, 0x01, 0x00, 0x00, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00	//255 
};

u8  code  WCRCh[256]={                        
0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 
0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 
0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 
0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 
0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 
0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 
0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 
0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 
0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 
0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 
0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 
0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 
0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 
0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 
0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 
0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 
0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 
0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 
0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 
0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 
0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 
0x80, 0x41, 0x00, 0xC1, 0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 
0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 0x80, 0x41, 0x00, 0xC1, 
0x81, 0x40, 0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 
0x00, 0xC1, 0x81, 0x40, 0x01, 0xC0, 0x80, 0x41, 0x01, 0xC0, 
0x80, 0x41, 0x00, 0xC1, 0x81, 0x40 	 };
u8  code  WCRCl[256]={
0x00, 0xC0, 0xC1, 0x01, 0xC3, 0x03, 0x02, 0xC2, 0xC6, 0x06, 
0x07, 0xC7, 0x05, 0xC5, 0xC4, 0x04, 0xCC, 0x0C, 0x0D, 0xCD, 
0x0F, 0xCF, 0xCE, 0x0E, 0x0A, 0xCA, 0xCB, 0x0B, 0xC9, 0x09, 
0x08, 0xC8, 0xD8, 0x18, 0x19, 0xD9, 0x1B, 0xDB, 0xDA, 0x1A, 
0x1E, 0xDE, 0xDF, 0x1F, 0xDD, 0x1D, 0x1C, 0xDC, 0x14, 0xD4, 
0xD5, 0x15, 0xD7, 0x17, 0x16, 0xD6, 0xD2, 0x12, 0x13, 0xD3, 
0x11, 0xD1, 0xD0, 0x10, 0xF0, 0x30, 0x31, 0xF1, 0x33, 0xF3, 
0xF2, 0x32, 0x36, 0xF6, 0xF7, 0x37, 0xF5, 0x35, 0x34, 0xF4, 
0x3C, 0xFC, 0xFD, 0x3D, 0xFF, 0x3F, 0x3E, 0xFE, 0xFA, 0x3A, 
0x3B, 0xFB, 0x39, 0xF9, 0xF8, 0x38, 0x28, 0xE8, 0xE9, 0x29, 
0xEB, 0x2B, 0x2A, 0xEA, 0xEE, 0x2E, 0x2F, 0xEF, 0x2D, 0xED, 
0xEC, 0x2C, 0xE4, 0x24, 0x25, 0xE5, 0x27, 0xE7, 0xE6, 0x26, 
0x22, 0xE2, 0xE3, 0x23, 0xE1, 0x21, 0x20, 0xE0, 0xA0, 0x60, 
0x61, 0xA1, 0x63, 0xA3, 0xA2, 0x62, 0x66, 0xA6, 0xA7, 0x67, 
0xA5, 0x65, 0x64, 0xA4, 0x6C, 0xAC, 0xAD, 0x6D, 0xAF, 0x6F, 
0x6E, 0xAE, 0xAA, 0x6A, 0x6B, 0xAB, 0x69, 0xA9, 0xA8, 0x68, 
0x78, 0xB8, 0xB9, 0x79, 0xBB, 0x7B, 0x7A, 0xBA, 0xBE, 0x7E, 
0x7F, 0xBF, 0x7D, 0xBD, 0xBC, 0x7C, 0xB4, 0x74, 0x75, 0xB5, 
0x77, 0xB7, 0xB6, 0x76, 0x72, 0xB2, 0xB3, 0x73, 0xB1, 0x71, 
0x70, 0xB0, 0x50, 0x90, 0x91, 0x51, 0x93, 0x53, 0x52, 0x92, 
0x96, 0x56, 0x57, 0x97, 0x55, 0x95, 0x94, 0x54, 0x9C, 0x5C, 
0x5D, 0x9D, 0x5F, 0x9F, 0x9E, 0x5E, 0x5A, 0x9A, 0x9B, 0x5B, 
0x99, 0x59, 0x58, 0x98, 0x88, 0x48, 0x49, 0x89, 0x4B, 0x8B, 
0x8A, 0x4A, 0x4E, 0x8E, 0x8F, 0x4F, 0x8D, 0x4D, 0x4C, 0x8C, 
0x44, 0x84, 0x85, 0x45, 0x87, 0x47, 0x46, 0x86, 0x82, 0x42, 
0x43, 0x83, 0x41, 0x81, 0x80, 0x40 	};

u16 xdata TimVal = 0;
u8  xdata T_O4=0;		        //口4超时计数器
u16 xdata SysTick_RTC = 0;
u8  xdata R_u4[255];
u8 xdata  W_u4[255];	        //串口4发送数组
u8  xdata R_OD4=0;   //串口4收到数据
u8  xdata R_CN4=0;   //口4长度计数器
bit Busy4 = 0;       //串口4发送标志
bit RTC_Flog=0;
u8     xdata        CrcH=0XFF;
u8     xdata        CrcL=0XFF;

#define S_N  0  // 补发次数
#define T_Ov 50 // 指令间延时（收到本条指令应答后到发送下条指令的延时，总线静默时间）
#define C_N  10 // 指令条数	0-1000条 （保证编译后xdata不超范围）
//#define S_ID 0x01  // 从机id    =0  主机   >0 从机

u8     xdata        BFCS_A=S_N;
u8 xdata ZLYS_B=T_Ov;
u16 xdata ZLTS_C=C_N;
u8 xdata CJID_D=Modbus_ID;

bit                 Flog=0;				//复用标志
bit S_R = 0;   // 发=0,收=1
u16    xdata        S_H=0;	            //当前序号 
u8	   xdata        E_R=0;	            //前次错误
u8	   xdata        S_C=0;              //已发次数
u8	   xdata        S_L=0;	            //发送长度
u8	   xdata        R_L=0;	            //接受长度

bit S1004_ONOFF=1;	        //上电初始化10指令04模式执行=0 上电初始化10指令04模式不执行=1  就是把屏保存的设定数据发送下位机一次（初始化)
bit RTC_EN=1;					//时钟开启=1 关闭=0

static void ModBus_Poll_Send(void);
static void ModBus_Poll_Revi(void);
static void ModBus_Slave_Revi(void);
static void Read_Time(void);
static u16 Read_Dgus(u16 Dgus_Addr);
static void Write_Dgus(u16 Dgus_Addr,u16 Val);
static void CRC_16(u8 Data);
static void Dt_Point(void); 
static void Send_DT(void);
static void Send_DT_Load(void);
static void R_DT_YD(void);
static void OneSendData4(u8 Dat);


extern void delay_ms(u16 n);
void ModBus_RTU_Slave_Init(void)
{
    u8 i = 0;
    for(i = 0; i < 255; i++) R_u4[i] = 0;
    R_CN4 = 0;
    R_OD4 = 0;
    Busy4 = 0;
    
     CrcH=0XFF;
     CrcL=0XFF;
     BFCS_A=S_N;
     ZLYS_B=T_Ov;
     ZLTS_C=C_N;
     CJID_D=Modbus_ID;
    
    UART5_Init();
}

void ModBus_RTU_Poll_Slave(void)
{
    ModBus_Slave_Revi();
}

void ModBus_RTC_ISR(void)
{
    if(TimVal<255)TimVal++;
    SysTick_RTC++;
    if(T_O4>0)T_O4--;
}

void UART5_Init(void)
{
    P0MDOUT |= 0x03;
    
    P0MDOUT |= 0x10;
    TX2 = 1;

    TR5=0;
    TR4=0;

    SCON3T=0x80;
    SCON3R=0x80;
	  if(MB_speed==1)
		{
			BODE3_DIV_H = BaudH_9600;
			BODE3_DIV_L = BaudL_9600;
		}
		else if(MB_speed==2)
		{
			BODE3_DIV_H = BaudH_115200;
			BODE3_DIV_L = BaudL_115200;
		}
		
		
    ES3T=1;
    ES3R=1;
    
    EA=1;
}

static void ModBus_Slave_Revi(void)
{
    if((R_OD4 == 1) && (T_O4==0))	//01 03 xxxx xxxx crch crcl
    {
        if(R_u4[0] == CJID_D)
        {
            u8 i=0;
            CrcH=0XFF;
            CrcL=0XFF;
            for(i=0;i<(R_CN4-2);i++) CRC_16(R_u4[i]);
            
            if((CrcH==R_u4[R_CN4-2])&&(CrcL==R_u4[R_CN4-1]))
            {
                if((R_u4[1]==1)||(R_u4[1]==2)) //ID 01 XXXX XXXX CRCH CRCL	
                {        
                    u16 TEMP=Read_Dgus((((R_u4[2]<<8)+R_u4[3])/16)+0X0100);
                    TR5=1;CrcH=0XFF;CrcL=0XFF; 
                    OneSendData4(R_u4[0]);CRC_16(R_u4[0]);
                    OneSendData4(R_u4[1]);CRC_16(R_u4[1]);
                    OneSendData4(2);      CRC_16(2);
                    OneSendData4((u8)(TEMP>>8));CRC_16((u8)(TEMP>>8));
                    OneSendData4((u8)(TEMP));CRC_16((u8)(TEMP));
                    OneSendData4(CrcH);	 OneSendData4(CrcL);while(Busy4); TR5=0;
                }
                
                if((R_u4[1]==3)||(R_u4[1]==4))	 //ID CMD XXXX XXXX CRCH CRCL
                {
                    u16 TEMP=0;	
                    W_u4[0]=R_u4[0];							   		    
                    W_u4[1]=R_u4[1]; 
                    W_u4[2]=R_u4[5]*2;
                    for(i=0;i<R_u4[5];i++) 
                    {      
                        TEMP=Read_Dgus(((R_u4[2]<<8)+R_u4[3])+i);
                        W_u4[3+2*i]=(u8)(TEMP>>8);
                        W_u4[4+2*i]=(u8)(TEMP);
                    }
                    TR5=1;
                    CrcH=0XFF;
                    CrcL=0XFF;   
                    for(i=0;i<(R_u4[5]*2)+3;i++)  //01 03 04 XX XX XX XX CRCH CRCL 
                    {OneSendData4(W_u4[i]);CRC_16(W_u4[i]);	}
                    OneSendData4(CrcH);	 OneSendData4(CrcL); while(Busy4);TR5=0;
                }
                
                if((R_u4[1]==5)||(R_u4[1]==6))	 //ID CMD XXXX XXXX CRCH CRCL
                {        
                    TR5=1;for(i=0;i<8;i++)OneSendData4(R_u4[i]);
                    Write_Dgus((R_u4[2]<<8)+R_u4[3],(R_u4[4]<<8)+R_u4[5]);
                    while(Busy4);TR5=0;
                }
                
                if(R_u4[1]==16)					//ID CMD  XXXX XXXX LEN XX XX XX XX CRCH CRCL
                {        
                    TR5=1;CrcH=0XFF;CrcL=0XFF;
                    for(i=0;i<6;i++){OneSendData4(R_u4[i]);CRC_16(R_u4[i]);	}
                    OneSendData4(CrcH);	 OneSendData4(CrcL); while(Busy4);TR5=0;
                    for(i=0;i<R_u4[5];i++)Write_Dgus(((R_u4[2]<<8)+R_u4[3])+i,(R_u4[7+2*i]<<8)+R_u4[8+2*i]);
                }
            }
            else
            {       
                TR5=1;CrcH=0XFF;CrcL=0XFF;
                W_u4[0]=R_u4[0];	  CRC_16(R_u4[0]);
                W_u4[1]=R_u4[1]&0x80; CRC_16(R_u4[1]);
                W_u4[2]=1;			  CRC_16(R_u4[2]);
                
                for(i=0;i<3;i++) OneSendData4(W_u4[i]);
                OneSendData4(CrcH);	 
                OneSendData4(CrcL); 
                while(Busy4);
                TR5=0;
            }
        }
        R_OD4=0;
        R_CN4=0;
    }
}

static u16 Read_Dgus(u16 Dgus_Addr)
{
    u16 R_Dgus=0;
    EA = 0;ADR_H = 0x00;
    ADR_M = (u8)((Dgus_Addr/2)>>8);
    ADR_L = (u8)(Dgus_Addr/2);
    RAMMODE = 0xAF; while(!APP_ACK);	//读操作
    APP_EN = 1;     while(APP_EN);
    if(Dgus_Addr%2)	R_Dgus = (DATA1<<8)+DATA0; 
    else            R_Dgus = (DATA3<<8)+DATA2;
    RAMMODE = 0; EA = 1;	return   R_Dgus;
}

static void Write_Dgus(u16 Dgus_Addr,u16 Val)
{           
    EA = 0;ADR_H = 0x00;
    ADR_M = (u8)((Dgus_Addr/2)>>8);
    ADR_L = (u8)(Dgus_Addr/2);
    RAMMODE = 0xAF;while(!APP_ACK);		//读操作
    APP_EN = 1;while(APP_EN);RAMMODE = 0;
    ADR_M = (u8)((Dgus_Addr/2)>>8);
    ADR_L = (u8)(Dgus_Addr/2);
    RAMMODE = 0x8F;while(!APP_ACK);		//写操作
    if(Dgus_Addr%2){DATA1=(u8)(Val>>8);DATA0=(u8)(Val);}
    else           {DATA3=(u8)(Val>>8);DATA2=(u8)(Val);}
    APP_EN = 1;	while(APP_EN);RAMMODE = 0;
    EA = 1;
}

static void  CRC_16(u8 Data)
{		    
    u8 index=0;
	index=CrcH^Data;CrcH=CrcL^WCRCh[index];CrcL=WCRCl[index]; 
}

static void Dt_Point(void)
{
    S_H++;	
    if(S_H==ZLTS_C)
    S_H=0;
    E_R=0;
    S_C=0;
    S_R=0;
}

static void Send_DT(void)
{
    u8 i=0;
    TR5=1;
    for(i=0;i<S_L;i++)OneSendData4(W_u4[i]);
    OneSendData4(CrcH);OneSendData4(CrcL);
    TimVal=0;S_C++;S_R=1;  //超时清零，收发置1	 发送次数+1
    while(Busy4);TR5=0;R_OD4=0;R_CN4=0;
}

static void Send_DT_Load(void)
{
    if((BT[S_H*12+2]==1)||(BT[S_H*12+2]==2))	 //01 01 xx xx xx xx crch crcl//01 02 XX XX XX XX CRCH CRCL
    {		   
        u8 i=0;							 
        W_u4[0]=	BT[S_H*12+1];  //ID		 
        W_u4[1]=	BT[S_H*12+2];  //CMD	 
        W_u4[2]=	BT[S_H*12+10]; //ADDERH	 
        W_u4[3]=	BT[S_H*12+11]; //ADDERL
        W_u4[4]=	0;       //LenH
        W_u4[5]=	BT[S_H*12+3];       //LenL
        CrcH=0XFF;CrcL=0XFF;
        for(i=0;i<6;i++)	CRC_16(W_u4[i]);
    }
    
    if((BT[S_H*12+2]==3)||(BT[S_H*12+2]==4))	 //01 03 XX XX XX XX CRCH CRCL//01 04 XX XX XX XX CRCH CRCL
    {		   
        u8 i=0;							 
        W_u4[0]=	BT[S_H*12+1];  //ID		 
        W_u4[1]=	BT[S_H*12+2];  //CMD	 
        W_u4[2]=	BT[S_H*12+10]; //ADDERH	 
        W_u4[3]=	BT[S_H*12+11]; //ADDERL
        W_u4[4]=	0;             //LenH
        W_u4[5]=	BT[S_H*12+3];  //LenL
        CrcH=0XFF;CrcL=0XFF;
        for(i=0;i<6;i++)	CRC_16(W_u4[i]);
    }
    
    if(BT[S_H*12+2]==5)								     //01 05 XX XX ff 00 CRCH CRCL	ff00 on  0000 off 
    {		   
        u8 i=0; 
        u16 Va=Read_Dgus((BT[S_H*12+8]<<8)+BT[S_H*12+9]);
        W_u4[0]=	BT[S_H*12+1];  //ID		 
        W_u4[1]=	BT[S_H*12+2];  //CMD	 
        W_u4[2]=	BT[S_H*12+10]; //ADDERH	 
        W_u4[3]=	BT[S_H*12+11]; //ADDERL
        W_u4[4]=	0x00; W_u4[5]=	0x00;
        if(Va>0) W_u4[4]=0xFF;
        CrcH=0XFF;CrcL=0XFF;
        for(i=0;i<6;i++)	CRC_16(W_u4[i]);
    }
    
    if(BT[S_H*12+2]==6)
    {          
        u8 i=0;u16 n=0;							 
        W_u4[0]=	BT[S_H*12+1];  //ID		         //01 06 xx xx xx xx crch crcl
        W_u4[1]=	BT[S_H*12+2];  //CMD	 
        W_u4[2]=	BT[S_H*12+10]; //ADDERH	 
        W_u4[3]=	BT[S_H*12+11]; //ADDERL
        n=Read_Dgus((BT[S_H*12+8]<<8)+BT[S_H*12+9]);
        W_u4[4]=(u8)(n>>8);             //DAT1
        W_u4[5]=(u8)(n);  //DAT0
        CrcH=0XFF;CrcL=0XFF;
        for(i=0;i<6;i++)	CRC_16(W_u4[i]);
    }
    
    if(BT[S_H*12+2]==15)                         //01 0f xx xx xx xx len xx xx crch crcl
    {       
        u8 i=0;u8 e=0;u16 n=0;u16 Temp=0;u16 Temp1=0;
        Temp=(BT[S_H*12+8]<<8)+BT[S_H*12+9];				
        W_u4[0]= BT[S_H*12+1];  //ID		         
        W_u4[1]=	BT[S_H*12+2];  //CMD
        W_u4[2]=	BT[S_H*12+10]; //ADDERH	 
        W_u4[3]=	BT[S_H*12+11]; //ADDERL
        W_u4[4]=	0;             //LenH
        W_u4[5]=	BT[S_H*12+3];  //LenL
        if(BT[S_H*12+3]%8==0) 
        W_u4[6]=(BT[S_H*12+3]/8);
            else 	W_u4[6]=(BT[S_H*12+3]/8+1);
         if(W_u4[6]%2==0)
         {  n=(W_u4[6]/2);
             for(i=0;i<n;i++)
           {   Temp1=Read_Dgus(Temp+i);   
            W_u4[2*i+7]= (u8)(Temp1>>8);
               W_u4[2*i+8]= (u8)(Temp1);
                 }
              }
         else { n=(W_u4[6]/2+1);
                  for(i=0;i<n;i++)
                  {  Temp1=Read_Dgus(Temp+i); 
        W_u4[2*i+7]= (u8)(Temp1>>8);
                            }
                            for(e=1;e<n;e++)
                     { Temp1=Read_Dgus(Temp+e-1);
                               W_u4[2*(e-1)+8]=(u8)(Temp1);}	
                  }
         CrcH=0XFF;CrcL=0XFF;
         for(i=0;i<(W_u4[6]+7);i++)CRC_16(W_u4[i]);		
    }

    if(BT[S_H*12+2]==16)
    {          u8 i=0;u16 n=0;u16 Temp=0;	             //01 10 XX XX XX XX len xx xx xx xx CRCH CRCL
    W_u4[0]=	BT[S_H*12+1];  //ID		         
    W_u4[1]=	BT[S_H*12+2];  //CMD	 
    W_u4[2]=	BT[S_H*12+10]; //ADDERH	 
    W_u4[3]=	BT[S_H*12+11]; //ADDERL
    W_u4[4]=	0;             //LenH
    W_u4[5]=	BT[S_H*12+3];  //LenL
    W_u4[6]=	W_u4[5]*2;	   //btyeLen
    Temp=(BT[S_H*12+8]<<8)+BT[S_H*12+9];
    for(i=0;i<W_u4[5];i++)
    {     n=Read_Dgus(Temp+i);
         W_u4[2*i+7]=(u8)(n>>8);
         W_u4[2*i+8]=(u8)(n);
    }
    CrcH=0XFF;CrcL=0XFF;
    for(i=0;i<(W_u4[6]+7);i++)CRC_16(W_u4[i]);
    }
}

static void        R_DT_YD()
{           if((R_u4[1]==1)||(R_u4[1]==2))	//ID CMD LEN XX CRCH CRCL
		     {		 u8 i=0;u8 j=0;
					if(R_u4[2]%2==0)
					{  for(i=0;i<R_u4[2]/2;i++) 
					  Write_Dgus((((BT[S_H*12+8]<<8)+BT[S_H*12+9])+i),((R_u4[3+2*i]<<8)+R_u4[4+2*i]));
					}
				else {j=R_u4[2]+3;R_u4[j]=0;for(i=0;i<R_u4[2]/2+1;i++)
				    Write_Dgus((((BT[S_H*12+8]<<8)+BT[S_H*12+9])+i),((R_u4[3+2*i]<<8)+R_u4[4+2*i]));
				   }
			}
			         
		    if((R_u4[1]==3)||(R_u4[1]==4))	//ID CMD LEN XX XX XX XX XX XX CRCH CRCL
		    {         u8 i=0;	   
		   			  for(i=0;i<BT[S_H*12+3];i++)
					  Write_Dgus((((BT[S_H*12+8]<<8)+BT[S_H*12+9])+i),((R_u4[3+2*i]<<8)+R_u4[4+2*i]));
		    }
		    Dt_Point();		           //发送指令条数指针+1
		    R_OD4=0;R_CN4=0;           //收到数据回零  接收器长度计数回零
}

static void OneSendData4(u8 Dat)
{            
    while(Busy4);               
	Busy4 = 1;
	SBUF3_TX = Dat;
}

void uart5_Risr() interrupt 13
{    
    R_u4[R_CN4] = SBUF3_RX;
    SCON3R &= 0xFE;
    R_OD4=1;
    R_CN4++;
    T_O4 = 25;
}

void uart5_Tisr() interrupt 12
{           
    SCON3T &= 0xFE ; 
    Busy4=0;
}
