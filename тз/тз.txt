Термостат фанкойла TC040C11 U04 — сводное ТЗ и описание
1) Назначение и состав устройства

Термостат предназначен для управления фанкойлом (3‑скоростной вентилятор + клапан) в режимах нагрев и охлаждение с локальной логикой, недельными расписаниями и обменом по Modbus/RS‑485. В качестве HMI используется DWIN TC040C11 U04 (4″ сенсорная панель) на чипе T5L1. В составе:

CPU/HMI: DWIN T5L1 (ASIC CPU).

Датчики температуры: 2 × NTC 10 кОм, подключены к ADC0 и ADC7.

Выходы на вентилятор: 3 замыкающих реле — 1‑я скорость [P13], 2‑я [P12], 3‑я [P14].

Выход на клапан: 1 перекидное реле — клапан [P11].

Интерфейс связи: RS‑485 (UART5), Modbus RTU.

Дизайн: интерфейс на панели TC040C11 выглядит очень красивым и современным — аккуратная 4″ панель с сенсорным управлением, лаконичная графика и чёткая индикация состояний.

2) Среда разработки и стек

Среда разработки прошивки контроллера: Keil uVision (как вы и запросили).

Алгоритмы и регистровая модель ниже — для реализации в микроконтроллере, взаимодействующем с HMI.

Обмен с HMI и внешней BMS — через Modbus/RS‑485.

3) Временная подсистема (RTC)

Таймер реального времени ведёт счёт секунд, минут, часов, дня, месяца, года и дня недели с выводом значений в регистры (см. карту регистров ниже).
Особенности:

День недели вычисляется по формуле «вечного календаря».

Правило записи со смещением +100: при записи полей даты/времени в регистры нужно прибавлять +100 к значениям (кроме года и дня недели). Например, чтобы установить 14 часов, в регистр часов записывается 114.

4) Измерение температуры

Читаются два термистора NTC 10 кОм (с АЦП ADC0 и ADC7).

Каждая температура измеряется с точностью до 0,1 °C, далее вычисляется средняя.

В карте регистров есть два представления: «Реальная температура» (с десятичной частью) и «Реальная температура (Целая часть)».

5) Основной алгоритм управления
5.1. Бинарное включение установки

Если «Включение установки» = 1 (выкл.), все реле скорости разомкнуты, а реле клапана открыто.
Во всех остальных случаях (установка включена) логика определяется режимом и скоростью.

5.2. Ручной выбор скорости

Если регистр «Скорость установки» равен 1/2/3, замыкается только соответствующее реле скорости, остальные — разомкнуты. Состояние клапана определяется сравнением реальной и заданной температур (см. ниже). Гистерезис — 1 °C.

5.3. Режимы «Нагрев» и «Охлаждение»: условие клапана (общая формула)

Определим Δt = t₂(реальная) − t₁(заданная).

Если реальная < заданной (Δt < 0), спецификация указывает, что реле клапана закрыто, иначе — открыто (гистерезис 1 °C). Это правило дано в тексте ТЗ и конкретизируется на графиках для авто‑режимов (см. ниже).

⚠️ Примечание: поведение клапана в «Нагреве» на приложенном графике нестандартно для типовых систем (см. описание графика); в данной документации отражено как в исходном ТЗ и приложенных рисунках.

5.4. Автоматический выбор скорости (Скорость = 4 (Авто))
5.4.1. Режим Нагрев — по рисунку «Режим нагрев.jpg»

График показывает ось Δt = t₂ − t₁ с отметками 0, −2, −4 °C. Состояния:

Δt > 0: Скорость 1, клапан открыт.

0 ≥ Δt > −2: Скорость 1, клапан закрыт.

−2 ≥ Δt > −4: Скорость 2, клапан закрыт.

Δt ≤ −4: Скорость 3, клапан закрыт.

Подписи на схеме: «СКОРОСТЬ 1/2/3» и «КЛАПАН ОТКРЫТ/ЗАКРЫТ». (См. приложенный файл «Режим нагрев.jpg».)

5.4.2. Режим Охлаждение — по рисунку «Режим охлаждения.jpg»

График показывает ось Δt с отметками 0, +2, +4 °C. Состояния:

Δt ≥ +4: Скорость 3, клапан открыт.

+2 ≤ Δt < +4: Скорость 2, клапан открыт.

0 ≤ Δt < +2: Скорость 1, клапан открыт.

Δt < 0: Скорость 1, клапан закрыт.

(См. приложенный файл «Режим охлаждения.jpg».)

В обоих авто‑режимах сохраняется гистерезис 1 °C на переключения.

6) Недельные расписания («Графики»)

Функция глобально включается регистром «Включение графиков»: 1 — выкл., 2 — вкл. (при 1 графики не работают). Настройка каждого из 4 графиков задаётся однотипным набором регистров:

Статус графика: 1 — неактивен, 2 — активен.

Дни графика: битовая маска (0…127) — 1‑й бит Пн, 2‑й Вт, 3‑й Ср, 4‑й Чт, 5‑й Пт, 6‑й Сб, 7‑й Вс.

Время старта: «Часы начала» и «Минуты начала» (оба с записью +100).

Время окончания: «Часы конца» и «Минуты конца» (оба с записью +100).

Параметры, которые применяются в момент старта: «Температура графика» и «Скорость графика» (вписываются в «Заданную температуру» и «Скорость установки» соответственно).

Завершение: в момент «Время конца»/«Минуты конца»:

если активен только этот график, установка выключается;

если активны другие графики, возвращаются значения скорости и уставки, которые были до активации данного графика.

7) Режим Modbus/RS‑485

Адрес устройства берётся из соответствующего регистра.

Скорость Modbus (baudrate) и формат кадра (стоп‑биты/чётность) задаются регистрами «Скорость Modbus» и «Протокол Modbus».

Физический интерфейс — UART5 → RS‑485.

Карта регистров

Ниже — полная карта регистров из файла «Регистры Термостат.xlsx» (HEX/DEC адреса и допустимые значения). Поле Тип: R — только чтение, W — только запись, R/W — чтение/запись.

A) Основные регистры работы

[R/W] Включение установки — 0x2060 (DEC 8288) — 1: выкл., 2: вкл.

[R/W] Скорость установки — 0x2061 (DEC 8289) — 1: 1‑я, 2: 2‑я, 3: 3‑я, 4: авто.

[R/W] Режим установки — 0x2062 (DEC 8290) — 1: охлаждение, 2: нагрев.

[R/W] Реальная температура — 0x2063 (DEC 8291) — 0.0…50.0 (шаг 0,1 °C).

[R/W] Реальная температура (целая часть) — 0x2064 (DEC 8292) — 0…50.

[R/W] Заданная температура — 0x2065 (DEC 8293) — 16.0…32.0 (шаг 0,1 °C).

[R/W] Заданная температура (целая часть) — 0x2066 (DEC 8294) — 16…32.

[R/W] Включение графиков — 0x2067 (DEC 8295) — 1: выкл., 2: вкл..

B) Дата и время (смещение +100 при записи, кроме года и дня недели)

[R] Дата_год — 0x2010 (DEC 8208) — 2020…2100.

[R] Дата_месяц — 0x2011 (DEC 8209) — 101…112 (месяц +100).

[R] Дата_день — 0x2012 (DEC 8210) — 101…131 (день +100).

[R] Дата_день недели — 0x2013 (DEC 8211) — формат на усмотрение программы.

[R] Время_часы — 0x2014 (DEC 8212) — 100…123 (часы +100).

[R] Время_минуты — 0x2015 (DEC 8213) — 100…159 (минуты +100).

[R] Время_секунды — 0x2016 (DEC 8214) — 100…159 (секунды +100).

C) График 1

[R/W] Статус графика — 0x2020 (DEC 8224) — 1: выкл., 2: вкл.

[R/W] Дни графика — 0x2021 (DEC 8225) — 0…127 (битовая маска дней).

[R/W] Скорость графика — 0x2022 (DEC 8226) — 1/2/3/4‑авто/5‑выкл.

[R/W] Температура графика — 0x2023 (DEC 8227) — 16…32.

[R/W] Часы начала — 0x2024 (DEC 8228) — 100…123 (часы +100).

[R/W] Минуты начала — 0x2025 (DEC 8229) — 100…159 (минуты +100).

[R/W] Часы конца — 0x2026 (DEC 8230) — 100…123 (часы +100).

[R/W] Минуты конца — 0x2027 (DEC 8231) — 100…159 (минуты +100).

D) График 2

[R/W] Статус графика — 0x2030 (DEC 8240) — 1: выкл., 2: вкл.

[R/W] Дни графика — 0x2031 (DEC 8241) — 0…127.

[R/W] Скорость графика — 0x2032 (DEC 8242) — 1/2/3/4‑авто/5‑выкл.

[R/W] Температура графика — 0x2033 (DEC 8243) — 16…32.

[R/W] Часы начала — 0x2034 (DEC 8244) — 100…123.

[R/W] Минуты начала — 0x2035 (DEC 8245) — 100…159.

[R/W] Часы конца — 0x2036 (DEC 8246) — 100…123.

[R/W] Минуты конца — 0x2037 (DEC 8247) — 100…159.

E) График 3

[R/W] Статус графика — 0x2040 (DEC 8256) — 1: выкл., 2: вкл.

[R/W] Дни графика — 0x2041 (DEC 8257) — 0…127.

[R/W] Скорость графика — 0x2042 (DEC 8258) — 1/2/3/4‑авто/5‑выкл.

[R/W] Температура графика — 0x2043 (DEC 8259) — 16…32.

[R/W] Часы начала — 0x2044 (DEC 8260) — 100…123.

[R/W] Минуты начала — 0x2045 (DEC 8261) — 100…159.

[R/W] Часы конца — 0x2046 (DEC 8262) — 100…123.

[R/W] Минуты конца — 0x2047 (DEC 8263) — 100…159.

F) График 4

[R/W] Статус графика — 0x2050 (DEC 8272) — 1: выкл., 2: вкл.

[R/W] Дни графика — 0x2051 (DEC 8273) — 0…127.

[R/W] Скорость графика — 0x2052 (DEC 8274) — 1/2/3/4‑авто/5‑выкл.

[R/W] Температура графика — 0x2053 (DEC 8275) — 16…32.

[R/W] Часы начала — 0x2054 (DEC 8276) — 100…123.

[R/W] Минуты начала — 0x2055 (DEC 8277) — 100…159.

[R/W] Часы конца — 0x2056 (DEC 8278) — 100…123.

[R/W] Минуты конца — 0x2057 (DEC 8279) — 100…159.

G) Настройка Modbus

[R] Адрес устройства — 0x2070 (DEC 8304) — 1…247.

[R] Скорость Modbus — 0x2071 (DEC 8305) — 1: 2400; 2: 4800; 3: 9600; 4: 19200; 5: 38400; 6: 57600; 7: 115200.

[R] Протокол Modbus — 0x2072 (DEC 8306) — 1: 8N1; 2: 8O1; 3: 8E1; 4: 8N2; 5: 8O2; 6: 8E2.

Описание приложенных изображений (для документации)

«Режим нагрев.jpg»
На горизонтальной шкале от +∞ до −∞ показан Δt = t₂(реальная) − t₁(заданная). Метки 0 °C, −2 °C, −4 °C делят шкалу на зоны, под каждой подпись:

слева от 0: «СКОРОСТЬ 1 / КЛАПАН ОТКРЫТ»;

при 0…−2 °C: «СКОРОСТЬ 1 / КЛАПАН ЗАКРЫТ»;

при −2…−4 °C: «СКОРОСТЬ 2 / КЛАПАН ЗАКРЫТ»;

при ≤ −4 °C: «СКОРОСТЬ 3 / КЛАПАН ЗАКРЫТ».
Сверху — формула Δt = t₂(реальная) − t₁(заданная).

«Режим охлаждения.jpg»
Та же шкала Δt с метками 0 °C, +2 °C, +4 °C и подписями:

при ≥ +4 °C: «СКОРОСТЬ 3 / КЛАПАН ОТКРЫТ»;

при +2…+4 °C: «СКОРОСТЬ 2 / КЛАПАН ОТКРЫТ»;

при 0…+2 °C: «СКОРОСТЬ 1 / КЛАПАН ОТКРЫТ»;

при < 0 °C: «СКОРОСТЬ 1 / КЛАПАН ЗАКРЫТ».

Графики подтверждают логику раздела 5.4.

Что нужно сделать (перечень задач для реализации прошивки)

RTC и регистры времени:

Реализовать счётчик RTC (сек/мин/час/дата/месяц/год/день недели).

Обработка смещения +100 при записи (кроме года и дня недели).

День недели — по формуле вечного календаря.

Измерение температуры:

Считать 2 × NTC 10 кОм (ADC0, ADC7), получить значения с точностью 0,1 °C.

Рассчитать среднюю температуру; писать в регистры «Реальная температура» и «Реальная температура (целая часть)».

Управление реле:

P13/P12/P14 — реле скоростей 1/2/3; P11 — перекидное реле клапана.

Логика включения в соответствии с режимом (нагрев/охлаждение), выбранной скоростью и авто‑алгоритмами (раздел 5). Гистерезис 1 °C.

Ручной/авто‑скорости:

При скоростях 1/2/3 — включать строго одно реле скорости.

При 4 (Авто) — вычислять Δt = t₂ − t₁ и выбирать состояние по соответствующему графику (см. раздел 5.4 и описание изображений).

Графики (4 шт.):

Глобальный тумблер «Включение графиков».

Для каждого графика — статус, дни (битовая маска), время начала/окончания (с записью +100), целевая температура и скорость.

В момент старта применять уставки графика; в момент окончания — выключать установку (если активен только этот график) или возвращать прежние уставки (если есть другие активные графики).

Modbus RTU (UART5/RS‑485):

Устанавливать адрес, скорость и формат кадра по соответствующим регистрам.

Обеспечить чтение/запись всех регистров карты выше.

Краткая «шпаргалка» по датчикам/выходам и интерфейсам

NTC: 10 кОм @ 25 °C, каналы ADC0/ADC7.

Реле вент.: 1‑я (P13), 2‑я (P12), 3‑я (P14).

Реле клапана: P11 (перекидное).

Δt: t₂(реальная) − t₁(заданная).

Modbus/RS‑485: UART5, адрес/baud/формат — через регистры.